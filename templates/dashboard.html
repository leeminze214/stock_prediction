<!-- File: templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SPX Technical Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8fafc; font-family: 'Segoe UI', Arial, sans-serif; }
        h1, h2 { font-weight: 600; }
        .table { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .table th, .table td { vertical-align: middle; font-size: 1.05rem; }
        .table-dark th { background: #222e3c !important; color: #fff; }
        .badge { font-size: 0.95rem; margin: 2px; }
        .form-select { border-radius: 6px; }
        #chart-container { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); padding: 1rem; }
        .btn-primary { background: #2563eb; border: none; }
        .btn-primary:hover { background: #1d4ed8; }
    </style>
</head>

<body>
    <div class="container p-4">
        <h1 class="mb-3">SPX Technical Dashboard</h1>
        <button onclick="location.reload()" class="btn btn-primary mb-3">Refresh Page</button>

        <div class="container mt-4">
            <h2 class="mb-3">Stock Dashboard</h2>
            <table class="table table-bordered text-center">
                <thead class="table-dark">
                    <tr>
                        <th></th>
                        <th style="background:#e3fcef">SPX (S&P 500)</th>
                        <th style="background:#fce3e3">ES (S&P 500 Futures)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>IB High / Low</td>
                        <td>{{ ib_high }} / {{ ib_low }}</td>
                        <td>{{ es_ib_high }} / {{ es_ib_low }}</td>
                    </tr>
                    <tr>
                        <td>VWAP (1D)</td>
                        <td>{{ vwap }}</td>
                        <td>{{ es_vwap }}</td>
                    </tr>
                    <tr>
                        <td>Support / Resistance</td>
                        <td>{{ support }} / {{ resistance }}</td>
                        <td>{{ es_support }} / {{ es_resistance }}</td>
                    </tr>
                    <tr>
                        <td>% Hit S/R</td>
                        <td>{{ prob_hit }}%</td>
                        <td>{{ es_prob_hit }}%</td>
                    </tr>
                    <tr>
                        <td>% Break R/S</td>
                        <td>{{ prob_break_res }}%</td>
                        <td>{{ es_prob_break_res }}%</td>
                    </tr>
                    <tr>
                        <td>1D Trend</td>
                        <td style="color:{{ 'green' if trend_1d == 'Up' else 'red' }}; font-weight:600;">{{ trend_1d }} ({{ prob1 }}%)</td>
                        <td style="color:{{ 'green' if es_trend_1d == 'Up' else 'red' }}; font-weight:600;">{{ es_trend_1d }} ({{ es_prob1 }}%)</td>
                    </tr>
                    <tr>
                        <td>1D Range</td>
                        <td>{{ range_low }} - {{ range_high }}</td>
                        <td>{{ es_range_low }} - {{ es_range_high }}</td>
                    </tr>
                    <tr>
                        <td>Patterns</td>
                        <td>
                            {% for p in patterns %}
                            <span class="badge bg-info text-dark">{{ p.time }} – {{ p.pattern }}</span>
                            {% endfor %}
                        </td>
                        <td>
                            {% if es_patterns %}
                                {% for p in es_patterns %}
                                <span class="badge bg-info text-dark">{{ p.time }} – {{ p.pattern }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">No patterns</span>
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="mt-4" id="chart-container">
                <!-- ...existing chart code... -->
            </div>
        </div>

        <h2 class="mt-4">Price Chart (1D)</h2>
        <div class="mb-2">
            <label for="symbolSelect">Symbol:</label>
            <select id="symbolSelect" class="form-select" style="width:auto;display:inline-block;">
                <option value="SPX">SPX</option>
                <option value="ES">ES</option>
            </select>
        </div>
        <canvas id="priceChart" height="100"></canvas>


    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script>
        let chart;
        async function draw(symbol = 'SPX') {
            const resp = await fetch(`/api/bars?bars=1d&symbol=${symbol}`);
            const data = await resp.json();
            console.log('Chart data:', data); // Debug output
            if (!data || data.length === 0) {
                document.getElementById('priceChart').getContext('2d').clearRect(0, 0, 600, 100);
                document.getElementById('priceChart').insertAdjacentHTML('afterend', '<div id="chartMsg" class="text-danger">No data available for chart.</div>');
                return;
            } else {
                const msg = document.getElementById('chartMsg');
                if (msg) msg.remove();
            }
            const labels = data.map(d => d.Datetime);
            const datasets = [
                { label: 'Close', data: data.map(d => d.Close), borderColor: '#007bff', fill: false },
                { label: 'SMA20', data: data.map(d => d.SMA20), borderColor: '#28a745', fill: false },
                { label: 'EMA20', data: data.map(d => d.EMA20), borderColor: '#ffc107', fill: false },
                { label: 'BB High', data: data.map(d => d.BB_High), borderColor: '#dc3545', fill: false },
                { label: 'BB Low', data: data.map(d => d.BB_Low), borderColor: '#6c757d', fill: false },
                { label: 'VWAP', data: data.map(d => d.VWAP), borderColor: '#6610f2', fill: false }
            ];
            if (chart) chart.destroy();
            chart = new Chart(document.getElementById('priceChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels.map(l => new Date(l)),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'minute', tooltipFormat: 'yyyy-MM-dd HH:mm' },
                            title: { display: true, text: 'Time' }
                        },
                        y: { title: { display: true, text: 'Price' } }
                    }
                }
            });
        }
        window.onload = () => {
            const symbolSelect = document.getElementById('symbolSelect');
            draw(symbolSelect.value);
            symbolSelect.onchange = () => draw(symbolSelect.value);
            setInterval(() => draw(symbolSelect.value), 60000);
        };
    </script>
</body>

</html>